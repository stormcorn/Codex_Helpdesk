name: Deploy via Portainer Webhook

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  deploy:
    name: Trigger Portainer Stack Redeploy
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Validate webhook secret exists
        env:
          PORTAINER_WEBHOOK_URL: ${{ secrets.PORTAINER_WEBHOOK_URL }}
        run: |
          test -n "$PORTAINER_WEBHOOK_URL" || { echo "Missing secret: PORTAINER_WEBHOOK_URL"; exit 1; }

      - name: Trigger Portainer webhook
        env:
          PORTAINER_WEBHOOK_URL: ${{ secrets.PORTAINER_WEBHOOK_URL }}
        run: |
          curl -fsS -X POST "$PORTAINER_WEBHOOK_URL"
